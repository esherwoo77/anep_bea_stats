---
title: "ANEP BEA Stats Query"
author: "Ed Sherwood"
date: "January 24, 2019"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(tidycensus) #Need an api key from US Census Bureau.
#library(tigris)
library(bea.R) #Need an api key from US BEA.
library(viridis)
library(rgdal)
library(sf)
#library(rmapshaper)
#library(gridExtra)
#library(mapview)
library(leaflet)
#options(tigris_class = "sf")
options(tigris_use_cache = TRUE)
knitr::opts_chunk$set(echo = FALSE)
```

## Get some US Cenus data

Download US Census data and overlay NEP boundaries:

```{r US Census Data}
nep_sf <- st_read(dsn = "./data-raw", layer = "NEP_Boundaries10162018")
states <- c("AL", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA",
            "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD",
            "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ",
            "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC",
            "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY",
            "PR")

totalpop_sf <- get_acs(geography = "county", variables = c(Income = "B19013_001"), 
                         state = states, geometry = TRUE)
ustotalpop_sf <- st_transform(totalpop_sf, st_crs(nep_sf))

nep_pop_intersects <- st_intersects(nep_sf, ustotalpop_sf)

nep_sel_sf <- ustotalpop_sf[unlist(nep_pop_intersects),]

nep_pop <- st_join(nep_sf, nep_sel_sf, join = st_intersects) %>%
           group_by(nep_pop$NEP_NAME) %>% 
           sf::st_buffer(dist = 0)
nep_pop_sum <- nep_pop %>% 
               select(NEP_NAME, estimate) %>%
               group_by(NEP_NAME) %>% 
               summarise(pop = median(estimate))

```

## Plot US Census data by NEP Project Areas

Plot US Census data that's restricted to the NEP boundaries:

```{r Display Census Data as a Map}

pal <- colorNumeric(palette = "viridis", domain = nep_pop_sum$pop, n = 10)

nep_pop_sum %>%
    st_transform(crs = "+init=epsg:4326") %>%
    leaflet(width = "100%") %>%
    addProviderTiles(provider = "CartoDB.Positron") %>%
    addPolygons(popup = ~ paste(NEP_NAME,"</br>","Median = ",pop),
                stroke = FALSE,
                smoothFactor = 0,
                fillOpacity = 0.7,
                color = ~ pal(pop)) %>%
    addLegend("bottomright", 
              pal = pal, 
              values = ~ pop,
              title = "Median Income",
              opacity = 1)

```

## Develop US BEA Plots

Work in progress ...  

```{r bea, echo=TRUE}

```
